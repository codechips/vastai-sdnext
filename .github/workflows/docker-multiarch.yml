name: Docker Multi-Architecture Build

# This workflow is disabled by default due to ARM64 compatibility issues
# Enable when ARM64 support is fixed

on:
  workflow_dispatch:
    inputs:
      enable_arm64:
        description: 'Enable ARM64 build (experimental)'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: codechips/vastai-sdnext

permissions:
  contents: read
  packages: write

jobs:
  build-multiarch:
    runs-on: ubuntu-latest
    if: github.event.inputs.enable_arm64 == 'true'
    
    steps:
    - name: Check out the repository's code
      uses: actions/checkout@v4
      
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: |
          image=moby/buildkit:latest
      
    - name: Log in to the GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=raw,value=multiarch-latest
          type=raw,value=multiarch-{{date 'YYYYMMDD'}}
        labels: |
          org.opencontainers.image.title=VastAI SD.Next (Multi-arch)
          org.opencontainers.image.description=SD.Next Docker image for Vast.ai (AMD64 + ARM64)
          org.opencontainers.image.vendor=codechips
          
    - name: Build and push multi-architecture image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          SDNEXT_VERSION=main
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        provenance: false

  arm64-test:
    runs-on: ubuntu-latest
    if: github.event.inputs.enable_arm64 == 'true'
    needs: build-multiarch
    
    steps:
    - name: Test ARM64 image
      run: |
        echo "ðŸ§ª Testing ARM64 compatibility..."
        echo "This would test the ARM64 image functionality"
        echo "Currently disabled due to QEMU emulation issues"
        
    - name: Report status
      run: |
        echo "## ðŸ—ï¸ Multi-Architecture Build" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status**: Experimental" >> $GITHUB_STEP_SUMMARY
        echo "**Platforms**: linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
        echo "**Known Issues**:" >> $GITHUB_STEP_SUMMARY
        echo "- ARM64 package installation failures in QEMU" >> $GITHUB_STEP_SUMMARY
        echo "- Emulation timeout issues with large installs" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next Steps**:" >> $GITHUB_STEP_SUMMARY
        echo "- Fix ARM64 compatibility in Dockerfile" >> $GITHUB_STEP_SUMMARY
        echo "- Test on native ARM64 runners when available" >> $GITHUB_STEP_SUMMARY